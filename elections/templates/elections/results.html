{% extends 'base.html' %}
{% load math_filters %}

{% block title %}Results: {{ election.title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5">
        <div class="text-center text-md-start mb-3 mb-md-0">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none brand-text-red fw-bold small">DASHBOARD</a></li>
                    <li class="breadcrumb-item active small text-uppercase tracking-wider">Tally Room</li>
                </ol>
            </nav>
            <h2 class="fw-bold brand-text-dark text-uppercase mb-0">
                <i class="bi bi-bar-chart-fill me-2 brand-text-red"></i>Election Results
            </h2>
            <p class="text-secondary small mt-1 mb-0">
                {{ election.title }} â€¢ 
                {% if election.is_active %}
                    <span class="text-success fw-bold"><i class="bi bi-record-circle-fill animate-pulse me-1"></i>LIVE TALLYING</span>
                {% else %}
                    <span class="text-muted fw-bold">SESSION CLOSED</span>
                {% endif %}
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-dark rounded-pill px-4 shadow-sm fw-bold small" onclick="window.print()">
                <i class="bi bi-printer me-2"></i> EXPORT REPORT
            </button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            {% for group in results_by_position %}
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5 brand-main-card">
                <div class="card-header bg-dark text-white py-3 px-4 d-flex justify-content-between align-items-center border-0">
                    <h5 class="mb-0 small fw-bold text-uppercase tracking-wider">{{ group.position.title }}</h5>
                    <span class="badge brand-badge-red px-3 py-2 small">
                        {{ group.candidates|length }} CANDIDATES
                    </span>
                </div>
                <div class="card-body p-4 p-md-5">
                    {% for r in group.candidates %}
                    <div class="result-row mb-5">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <div class="position-relative me-3">
                                    {% if r.candidate.photo %}
                                        <img src="{{ r.candidate.photo.url }}" alt="{{ r.candidate.name }}" 
                                            class="brand-squircle-img shadow-sm border border-2 border-white">
                                    {% else %}
                                        <div class="brand-squircle-img bg-secondary d-flex align-items-center justify-content-center text-white border border-2 border-white shadow-sm">
                                            <i class="bi bi-person-fill fs-4"></i>
                                        </div>
                                    {% endif %}
                                    {% if forloop.first and r.count > 0 %}
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success border border-2 border-white">
                                            <i class="bi bi-trophy-fill p-1"></i>
                                        </span>
                                    {% endif %}
                                </div>
                                <div>
                                    <h6 class="fw-bold brand-text-dark mb-0 fs-5">{{ r.candidate.name }}</h6>
                                    <p class="x-small text-secondary fw-bold text-uppercase mb-0">Total Votes: {{ r.count }}</p>
                                </div>
                            </div>
                            <div class="text-end">
                                <h3 class="fw-bold brand-text-red mb-0">{{ r.percentage|floatformat:1 }}%</h3>
                            </div>
                        </div>

                        <div class="progress rounded-pill shadow-sm" style="height: 12px; background-color: rgba(0,0,0,0.05);">
                            <div class="progress-bar progress-bar-animated bg-brand-red" 
                                 role="progressbar" 
                                 style="width: {{ r.percentage }}%;" 
                                 aria-valuenow="{{ r.percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4">
                <div class="card-body p-4 text-center bg-dark text-white">
                    <div class="brand-icon-circle mx-auto mb-3">
                        <i class="bi bi-envelope-paper-fill fs-3 text-white"></i>
                    </div>
                    <h6 class="text-uppercase opacity-50 small fw-bold tracking-wider">Total Participation</h6>
                    <h1 class="display-3 fw-bold mb-0">{{ total_votes }}</h1>
                    <p class="small opacity-75">Votes Verified & Cast</p>
                </div>
                <div class="card-footer bg-white border-0 p-4">
                    <h6 class="fw-bold brand-text-dark small text-uppercase mb-3 tracking-tight">Timeline Info</h6>
                    <div class="d-flex align-items-center mb-3">
                        <div class="brand-mini-box me-3"><i class="bi bi-calendar-event"></i></div>
                        <div>
                            <p class="x-small text-secondary fw-bold text-uppercase mb-0">Polls Opened</p>
                            <span class="small fw-bold">{{ election.start_time|date:"M d, Y | H:i" }}</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="brand-mini-box me-3"><i class="bi bi-clock-history"></i></div>
                        <div>
                            <p class="x-small text-secondary fw-bold text-uppercase mb-0">Polls Closing</p>
                            <span class="small fw-bold">{{ election.end_time|date:"M d, Y | H:i" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 bg-body-tertiary p-4">
                <h6 class="fw-bold brand-text-dark small text-uppercase mb-3"><i class="bi bi-info-circle-fill me-2 brand-text-red"></i>Registry Note</h6>
                <p class="x-small text-secondary mb-0">
                    Results are updated in real-time. Final certification occurs 24 hours after the session is officially closed.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --brand-red: #A32020;
        --brand-dark: #121212;
    }

    .brand-text-red { color: var(--brand-red) !important; }
    .brand-text-dark { color: var(--brand-dark) !important; }
    .bg-brand-red { background-color: var(--brand-red) !important; }
    .x-small { font-size: 0.7rem; }
    .tracking-wider { letter-spacing: 1.5px; }

    /* Squircle Profile Requirements */
    .brand-squircle-img {
        width: 55px; height: 55px;
        border-radius: 14px; /* Signature Squircle */
        object-fit: cover;
    }

    /* Progress & Icons */
    .progress-bar { transition: width 1.5s cubic-bezier(0.1, 0, 0, 1); }
    .brand-icon-circle {
        width: 60px; height: 60px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
    }
    .brand-mini-box {
        width: 32px; height: 32px;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        color: var(--brand-red);
    }

    .brand-badge-red {
        background-color: rgba(163, 32, 32, 0.1);
        color: var(--brand-red);
        border: 1px solid rgba(163, 32, 32, 0.2);
    }

    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    @media print {
        .btn, .breadcrumb, .brand-icon-circle, .card-footer { display: none !important; }
        .card { box-shadow: none !important; border: 1px solid #eee !important; }
    }

    [data-bs-theme="dark"] .brand-main-card { background-color: #1a1a1a; }
    [data-bs-theme="dark"] .brand-mini-box { background-color: #2b2b2b; }
</style>
{% endblock %}